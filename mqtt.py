#!/usr/bin/python3

from paho.mqtt import client as mqtt_client
import random, time, sys, signal

broker=''
port = 1883
topic = ""
client_id = f'python-mqtt-{random.randint(0,1000)}'
username = ''
password = ''

def sig_handler(sig, frame):
	print("\n\n[] Saliendo...\n")
	sys.exit(0)

signal.signal(signal.SIGINT, sig_handler)

def connect_mqtt() -> mqtt_client:
	def on_connect(client, userdata, flags, rc):
		if rc == 0:
			print('Connected to MQTT Broker!')
		else:
			print('Failed to connect, return code %d\n', rc)

	client = mqtt_client.Client(client_id)
	client.username_pw_set(username, password)
	client.on_connect = on_connect
	client.connect(broker, port)
	return client

#def subscribe(client: mqtt_client):
#	def on_message(client, userdata, msg):
#		print(f'Received `{msg.payload.decode()}` from `{msg.topic}` topic')
#
#	client.subscribe(topic)
#	client.on_message = on_message

def publish(client):
	msg_count = 100
	while msg_count<121:
		time.sleep(3)
		msg = "%s" %(msg_count)
		result = client.publish(topic, msg)
		status = result[0]
		if status == 0:
			print(f'Send `{msg} to topic `{topic}`')
		else:
			print(f'Failed to send message to topic {topic}')
		msg_count += 1

def parametros():

    global broker,topic,port,username,password

    if len(sys.argv) <= 6:
    	ayuda()
    else:
    	n = len(sys.argv)
    	for i in range (n):
            if (sys.argv[i] == "-t"):
	            topic = sys.argv[i+1]
            elif (sys.argv[i] == "-b"):
	            broker = sys.argv[i+1]
            elif (sys.argv[i] == "-p"):
	            port = int(sys.argv[i+1])
            elif (sys.argv[i] == "-u"):
	            username = sys.argv[i+1]
            elif (sys.argv[i] == "-pw"):
	            password = sys.argv[i+1]
            else:
                pass
    	imprimir_param()
    	run()

def ayuda():
	print("[*] mqtt.py - uso de la aplicación:\n")
	print("\t-b:\tIndica la dirección del broker\n")
	print("\t-p:\tIndica el puerto a usar\n")
	print("\t-t:\tIndica el topic bajo el que se quiere publicar\n")
	print("\t-u:\tIndica el usuario\n")
	print("\t-pw:\tIndica el password\n")

def imprimir_param():
	print("Broker - {}".format(broker))
	print("Puerto - {}".format(port))
	print("topic - {}".format(topic))


def run():

	client = connect_mqtt()
	client.loop_start()
	publish(client)

if __name__ == '__main__':
    parametros()

